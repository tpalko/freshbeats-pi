{% load staticfiles %}

<html>

	<head>
		<title>FreshBeats</title>

		<script type="text/javascript" src="{% static "bower_components/jquery/dist/jquery.min.js" %}"></script>
		<script type="text/javascript" src="{% static "bower_components/datatables/media/js/jquery.dataTables.min.js" %}"></script>
		<script type="text/javascript" src="{% static "spin.min.js" %}"></script>

		<link rel="stylesheet" type="text/css" href="{% static "bootstrap/css/bootstrap.min.css" %}" />
		<link rel="stylesheet" type="text/css" href="{% static "bower_components/jquery-ui/jquery-ui.min.js" %}" />
		<link rel="stylesheet" type="text/css" href="{% static "bower_components/datatables/media/css/dataTables.jqueryui.min.css" %}" />
		<link rel="stylesheet" type="text/css" href="{% static "beater.css" %}" />

	</head>

	<body>

		<div class="container-fluid">

			<div class="row title">
				<div class="col-md-1">
					<h2>Hy!asdf</h2>
				</div>
				<div class="col-md-6">
					<a class="btn btn-info" href="{% url "search" %}">search</a>
					<a class="btn btn-info" href="{% url "mobile" %}">mobile</a>
					<a class="btn btn-info" href="{% url "manage" %}">manage</a>
					<a class="btn btn-info" href="{% url "report" %}">report</a>
					<a class="btn btn-info" href="{% url "survey" %}">survey</a>
					<a class="command btn btn-primary" endpoint="player" command="surprise" href="#">surprise me</a>
					<a class="command btn btn-primary" endpoint="player" command="playlist" href="#">playlist</a>
					<a class="command btn btn-default" endpoint="player" command="shuffle" href="#">shuffle is off</a>
				</div>
				<div class="col-md-4">
					<a class="btn btn-warning command" endpoint="player" href="#" command="pause">pause</a>
					<a class="btn btn-danger command" endpoint="player" href="#" command="stop">stop</a>
					<a class="btn btn-success command" endpoint="player" href="#" command="play">play</a>
					<a class="btn btn-warning command" endpoint="player" href="#" command="next">next</a>
					<a class="btn btn-default command" endpoint="player" href="#" command="mute">mute is off</a>
				</div>
				<div class="col-md-1">
					<div id="player_info"></div>
				</div>
			</div>

			<div class="row" style="height:0em; margin-bottom: 0em;">
				<div class="col-md-12" id="errors"></div>
			</div>

			{% block content %}{% endblock %}

		</div>

		<script type="text/javascript" src="{% static "jquery/jquery-ui-1.11.1.custom/jquery-ui.min.js" %}"></script>
		<script type="text/javascript" src="{% static "socket.io.slim.js" %}"></script>

		<script type="text/javascript">

			var spinner_opts = {
				  lines: 5 // The number of lines to draw
				, length: 56 // The length of each line
				, width: 5 // The line thickness
				, radius: 84 // The radius of the inner circle
				, scale: 0.25 // Scales overall size of the spinner
				, corners: 1 // Corner roundness (0..1)
				, color: '#000' // #rgb or #rrggbb or array of colors
				, opacity: 0.25 // Opacity of the lines
				, rotate: 18 // The rotation offset
				, direction: 1 // 1: clockwise, -1: counterclockwise
				, speed: 0.5 // Rounds per second
				, trail: 100 // Afterglow percentage
				, fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
				, zIndex: 2e9 // The z-index (defaults to 2000000000)
				, className: 'spinner' // The CSS class to assign to the spinner
				, top: '50%' // Top position relative to parent
				, left: '50%' // Left position relative to parent
				, shadow: false // Whether to render a shadow
				, hwaccel: false // Whether to use hardware acceleration
				, position: 'absolute' // Element positioning
			};

			var tabs;
			var socket;

			function getCookie(name) {
			    var cookieValue = null;
			    if (document.cookie && document.cookie != '') {
			        var cookies = document.cookie.split(';');
			        for (var i = 0; i < cookies.length; i++) {
			            var cookie = jQuery.trim(cookies[i]);
			            // Does this cookie string begin with the name we want?
			            if (cookie.substring(0, name.length + 1) == (name + '=')) {
			                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			                break;
			            }
			        }
			    }
			    return cookieValue;
			}

			var csrftoken = getCookie('csrftoken');

			function csrfSafeMethod(method) {
			    // these HTTP methods do not require CSRF protection
			    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}

			function sameOrigin(url) {
			    // test that a given url is a same-origin URL
			    // url could be relative or scheme relative or absolute
			    var host = document.location.host; // host + port
			    var protocol = document.location.protocol;
			    var sr_origin = '//' + host;
			    var origin = protocol + sr_origin;
			    // Allow absolute or scheme relative URLs to same origin
			    return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
			        (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
			        // or any other URL that isn't scheme relative or absolute i.e relative.
			        !(/^(\/\/|http:|https:).*/.test(url));
			}

			var album_songs_url = "{% url "album_songs" 0 %}";

			$(document).on('blur', "input.blurpost", function(e) {
				e.preventDefault();

				// -- grab the input and validate it
				var input = $(this);

				if(input.val().trim() == '') {
					return false;
				}

				// -- grab the form and the callback function  to handle the edit response
				var form = $(this).closest('form');
				var callback = $(this).data("callback");

				// -- grab the saved html to swap back in
				var savedro = $(form).find(".savero");
				var savedroEl;

				if (savedro.length > 0) {
					var savedroEl = $.parseHTML(savedro.html().replace(/^<!--/, '').replace(/-->$/, ''));
					$(savedro).remove();
				}

				// -- make the update call
				// -- swap the original thing back in (over the form)
				// -- call the callback with the response data 
				$.ajax({
					url: $(form).attr('action'),
					data: $(form).serialize(),
					type: $(form).attr("method"),
					dataType: "json",
					success: function(data, textStatus, jqXHR) {
						if (savedroEl) {
							$(form).replaceWith(savedroEl);
						}
						window[callback](data);
						$(e.target).val("");
					},
					error: function(jqXHR, textStatus, errorThrown) {
						$("<div />").addClass('error').text(errorThrown).appendTo($(form));
					}
				});
				return false;
			});

			$(document).on('click', '.inline-edit', function(e){

				// -- get the html of the thing we're editing in a new div
				var savero = $("<div />").append($(this).clone()).html();

				// -- create a new form to submit the edit
				var newForm = $("<form />")
					.attr("method", $(this).data("form-method"))
					.attr("action", $(this).data("form-action"));

				// -- add a form field to represent the value we're editing
				var newInput = $("<input />")
					.attr("type", "text")
					.attr("name", $(this).data("input-name"))
					.addClass("blurpost")
					.addClass("col-md-3")
					.attr("data-callback", $(this).data("callback"))
					.attr("value", $(this).text());
				$(newInput).appendTo(newForm);

				// -- add to the form a span with the commented, saved html
				$("<span />").addClass('savero').html("<!--" + savero + "-->").appendTo(newForm);

				// -- swap the thing we're editing with the new form
				$(this).replaceWith(newForm);
				$(newInput).focus();
			});

			$(document).on('mouseover', '.album', function(e){

				e.preventDefault();

				var album_id = $(this).closest("tr").data('id');

				if(album_id == undefined){
					album_id = $(this).data('id');
				}

				if(album_id == undefined){
					return;
				}

				var row = $(this).closest("tr");

				if(row.attr("title") != undefined){
					return;
				}

				$.ajax({
					url: album_songs_url.replace(/0/, album_id),
					type: "GET",
					dataType: "json",
					success: function(data){
						$(row).attr("title", data);
					}
				});
			});

			$.ajaxSetup({
			    beforeSend: function(xhr, settings) {
			        if (!csrfSafeMethod(settings.type) && !this.crossDomain) { //sameOrigin(settings.url)) {
			            // Send the token to same-origin, relative URLs only.
			            // Send the token only if the method warrants CSRF protection
			            // Using the CSRFToken value acquired earlier
			            xhr.setRequestHeader("X-CSRFToken", csrftoken);
			        }
			    },
			    error: function(jqXHR, textStatus, errorThrown){

			    	if(jqXHR.responseText == undefined || jqXHR.responseText == ""){
			    		console.log("jqXHR.responseText does not have a value");
			    		return;
			    	}

			    	console.log(errorThrown);

			    	var a = jqXHR.responseText.split('\n');

			    	showError(a[0] + "<br />" + a[1]);
			    }
			});

			function showError(message){

				$("#errors").append($("<div></div>").html(message));
			}

			function keepalbum_callback(response){

				album_id = response.albumid;
				$("tr[albumid='" + album_id + "']").find(".album_action").html("");
			}

			$(document).on('change', "input[name='rating']", function(e){

				var is_unrated = $(this).val() == "unrated";
				$("input[name='keep']").prop("checked", is_unrated ? "checked" : "");
			});

			$(document).on('change', "input[name='status']", function(e){

				var is_not_ok = $(this).val() != "ok";
				$("input[name='keep']").prop("checked", is_not_ok ? "" : "checked");
			});

			$(document).on("click", "a.ajax", function(e){

				e.preventDefault();

				var href = $(this).attr("href");
				var action = $(this).data("action");

				$.ajax({
					url: href,
					data: { action: action },
					type: "POST",
					dataType: "json",
					success: function(data){

					},
					error: function(error){

					}
				});
			});

			var command_url = '{% url "command" "null" %}';

			$(document).on('click', "a.command", function(e){

				var clickable = $(this);
				var endpoint = $(this).attr("endpoint");
				var command = $(this).attr("command");
				var albumid = $(this).attr("albumid");
				var songid = $(this).attr("songid");

				var url = command_url.replace(/null/, endpoint);

				$.ajax({

					url: url,
					data: { command: command, albumid: albumid, songid: songid },
					type: "POST",
					datatype: "json",
					success: function(data, textStatus, jqXHR){
						var callback = $(clickable).attr('callback');

						if(callback != undefined){
							fn = window[callback];
							fn(JSON.parse(data));
						}
					}
				});

				return false;
			});

			$(document).on('submit', 'form[id^="surveyalbum_"]', function(e){

				e.preventDefault();

				$.ajax({

					url: '{% url "survey_post" %}',
					data: $(this).serialize(),
					type: "POST",
					datatype: "json",
					success: function(data, textStatus, jqXHR){
						location = location;
					}
				});

				return false;
			});

			$(document).ready(function(){

				tabs = $("#tabs").tabs({
					load: function(event, ui){
						//console.log("here");
					},
					beforeLoad: function(event, ui){
						//console.log("there");
					},
					beforeActivate: function(event, ui){
						console.log('beforeactivate');
						console.log(ui.newTab);
					},
					activate: function(event, ui){
						console.log(ui);
					},
					active: 0
				});

				$.ajax({
					url: '{% url "player_status_and_state" %}',
					type: 'GET',
					success: function(data, textStatus, jqXHR){}
				});
			});

			{% include 'js/common/socketio_client.js' %}

			{% if page_script_path %}
			{% include page_script_path %}
			{% endif %}

		</script>

	</body>
</html>
